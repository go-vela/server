version: "1"

metadata:
  render_inline: true

secrets:
  - name: foo
    key: org/repo/foo
    type: repo
    engine: native

  - origin:
      name: push main secrets
      image: vault:latest
      ruleset:
        event: push
        branch: main
      parameters:
        foo: bar

  - origin:
      name: deployment secrets
      image: vault:latest
      ruleset:
        event: deployment
      parameters:
        foo: bar

services:
  - name: database
    image: postgres:latest
    ruleset:
      event: push
      branch: main
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

  - name: redis
    image: redis:latest
    ruleset:
      event: deployment
    environment:
      REDIS_PASSWORD: redis

templates:
  - name: golang
    source: github.example.com/github/octocat/golang_inline_stages.yml
    format: golang
    type: github
    vars:
      image: golang:latest
  - name: starlark
    source: github.example.com/github/octocat/starlark_inline_stages.star
    format: starlark
    type: github

stages:
  test:
    steps:
      - name: test
        image: alpine
        commands:
          - echo from inline
      - name: ruleset
        image: alpine
        ruleset:
          event: push
          branch: main
        commands:
          - echo from inline ruleset